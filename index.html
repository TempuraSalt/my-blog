<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ブログ</title>
  <meta name="description" content="個人ブログ。メモや学びをまとめます。">
  <link rel="stylesheet" href="/my-blog/style.css" />
  <!-- common.js は defer のまま読み込む（ただしここで存在確認を行います） -->
  <script src="/my-blog/common.js" defer></script>
  <style>
    /* 簡単なデバッグ表示用スタイル */
    .debug-box{background:#fff3f3;color:#900;padding:12px;border-radius:8px;margin:12px 0;font-family:monospace;white-space:pre-wrap}
    .ok-box{background:#f3fff7;color:#064;padding:12px;border-radius:8px;margin:12px 0;font-family:monospace;white-space:pre-wrap}
  </style>
</head>
<body>
  <div id="site-header"></div>

  <main class="container">
    <section class="hero">
      <p>ここは「ブログ」です。日々のメモや学びをまとめます。</p>
    </section>

    <section id="posts" class="posts" aria-label="記事一覧">
      <!-- JavaScriptで埋める -->
    </section>

    <!-- デバッグ表示領域 -->
    <section id="debug" aria-hidden="false"></section>
  </main>

  <div id="site-footer"></div>

  <script>
  // 全体を DOMContentLoaded で待つ（common.js が defer で実行された後に確実に動きます）
  document.addEventListener('DOMContentLoaded', function () {
    // helper
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    (async function(){
      try{
        // 確認用（デバッグ）：loadPosts が関数か確認
        if(typeof loadPosts !== 'function'){
          console.error('loadPosts is not a function even after DOMContentLoaded. common.js may not define it.');
          document.getElementById('posts').innerHTML = '<pre style="color:#c00;background:#fff3f3;padding:12px;border-radius:6px;">読み込みエラー: loadPosts が見つかりません。common.js の内容を確認してください。</pre>';
          return;
        }

        const posts = await loadPosts();
        const el = document.getElementById('posts');
        if(!posts || posts.length === 0){
          el.innerHTML = '<p>まだ記事がありません。</p>';
          return;
        }
        posts.sort((a,b)=> b.date.localeCompare(a.date));

        posts.forEach(p=>{
          let coverHtml = '';
          if(p.cover){
            if(/\.webp$/i.test(p.cover)){
              const webp = p.cover;
              const jpg = webp.replace(/\.webp$/i,'.jpg');
              coverHtml = `<div class="card-cover"><picture><source type="image/webp" srcset="${webp}"><img src="${jpg}" alt="${escapeHtml(p.title)}" loading="lazy"></picture></div>`;
            } else {
              coverHtml = `<div class="card-cover"><img src="${p.cover}" alt="${escapeHtml(p.title)}" loading="lazy"></div>`;
            }
          }
          const tagsHtml = (p.tags && p.tags.length) ? `<div class="post-tags">${p.tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>` : '';
          const html = `
<article class="post-card">
  ${coverHtml}
  <div class="card-body">
    <h3><a href="${p.url}">${escapeHtml(p.title)}</a></h3>
    <div class="post-meta">${escapeHtml(p.date)}</div>
    <p>${escapeHtml(p.excerpt || '')}</p>
    ${tagsHtml}
  </div>
</article>`;
          el.insertAdjacentHTML('beforeend', html);
        });
      }catch(err){
        console.error('posts load error', err);
        document.getElementById('posts').innerHTML = '<pre style="color:#c00;background:#fff3f3;padding:12px;border-radius:6px;">読み込みエラー:\\n' + escapeHtml(String(err)) + '</pre>';
      }
    })();
  });
</script>

</body>
</html>
