<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ブログ</title>
  <meta name="description" content="個人ブログ。メモや学びをまとめます。">
  <link rel="stylesheet" href="/my-blog/style.css" />
  <script src="/my-blog/common.js" defer></script>
</head>
<body>
  <div id="site-header"></div>

  <main class="container">
    <section class="hero">
      <p>ここは「ブログ」です。日々のメモや学びをまとめます。</p>
    </section>

    <section id="posts" class="posts" aria-label="記事一覧">
      <!-- JavaScriptで埋める -->
    </section>
  </main>

  <div id="site-footer"></div>

  <script>
  document.addEventListener('DOMContentLoaded', async function () {
    /**
     * HTMLエスケープ処理（XSS対策）
     * @param {any} input - エスケープする値
     * @returns {string} エスケープされた文字列
     */
    function escapeHtml(input) { 
      if (input == null) return ''; 
      return String(input)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#x27;');
    }

    try {
      // loadPosts関数が利用可能になるまで安全に待機
      let attempts = 0;
      const maxAttempts = 100; // 5秒間待機
      
      while (typeof loadPosts !== 'function' && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 50));
        attempts++;
      }

      if (typeof loadPosts !== 'function') {
        throw new Error('loadPosts関数が利用できません');
      }

      const posts = await loadPosts();
      const postsElement = document.getElementById('posts');
      
      if (!postsElement) {
        console.error('posts要素が見つかりません');
        return;
      }
      
      if (!posts || posts.length === 0) {
        postsElement.innerHTML = '<p>まだ記事がありません。</p>';
        return;
      }

      // 日付順にソート（新しい順）
      posts.sort((a, b) => b.date.localeCompare(a.date));

      // 記事カードを生成
      const cardsHtml = posts.map(post => {
        // 入力値の検証
        if (!post.title || !post.url || !post.date) {
          console.warn('無効な記事データをスキップ:', post);
          return '';
        }

        let coverHtml = '';
        if (post.cover && typeof post.cover === 'string') {
          coverHtml = `<div class="card-cover"><img src="${escapeHtml(post.cover)}" alt="${escapeHtml(post.title)}" loading="lazy" onerror="this.style.display='none'"></div>`;
        }
        
        const tagsHtml = (post.tags && Array.isArray(post.tags) && post.tags.length) ? 
          `<div class="post-tags">${post.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}</div>` : '';
        
        return `
<article class="post-card">
  ${coverHtml}
  <div class="card-body">
    <h3><a href="${escapeHtml(post.url)}">${escapeHtml(post.title)}</a></h3>
    <div class="post-meta">${escapeHtml(post.date)}</div>
    <p>${escapeHtml(post.excerpt || '')}</p>
    ${tagsHtml}
  </div>
</article>`;
      }).filter(html => html.length > 0).join('');

      postsElement.innerHTML = cardsHtml;

    } catch (error) {
      console.error('記事読み込みエラー:', error);
      const postsElement = document.getElementById('posts');
      if (postsElement) {
        postsElement.innerHTML = '<p>記事の読み込みに失敗しました。ページを再読み込みしてください。</p>';
      }
    }
  });
  </script>
</body>
</html>
